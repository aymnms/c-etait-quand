<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C'était Quand ?</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        #startGame, #game, #results, #next, #endGame { display: none; }
        img { max-width: 100%; max-height: 100vh;}
    </style>
</head>
<body>
    <div id="setup">
        <h1>Entrez les noms des joueurs</h1>
        <form id="playerForm">
            <input type="text" placeholder="Nom du joueur" id="playerInput">
            <button type="button" onclick="joinGame()">Rejoindre la Partie</button>
        </form>
        <h3>Code de la salle : <span id="roomCode"></span></h3>
        <button id="startGame" onclick="nextRound()">Lancer la partie</button>
        <ul id="playerListSetup"></ul>
    </div>

    <div id="game">
        <img id="questionImage" src=""/>
        <h2 id="question"></h2>
        <h3>Temps restant : <span id="timer">30</span> secondes</h3>
        <div id="answers"></div>
        <button onclick="validateAnswers()">Valider</button>
        <ul id="playerListGame"></ul>
    </div>

    <div id="results">
        <h2 id="roundResult"></h2>
        <p id="explanation"></p>
        <table border="1" id="currentAnswers"></table>
        <br />
        <table border="1" id="currentScores"></table>
        <button id="next" onclick="nextRound()">Suivant</button>
    </div>

    <div id="endGame" class="hidden">
        <h1>Partie terminée !</h1>
        <table border="1" id="finalScores"></table>
        <h2 id="winner"></h2>
    </div>

    <script>
        const ENV = window.location.href.includes("index.html") ? "local" : window.location.href.includes("preprod") ? "preprod" : "prod";

        const CONFIG = {
            local: {
                BACKEND_URL: "http://localhost:3000",
            },
            preprod: {
                BACKEND_URL: "https://c-etait-quand-back-preprod.onrender.com",
            },
            prod: {
                BACKEND_URL: "https://c-etait-quand-back.onrender.com",
            }
        };

        if (ENV != "prod") document.title = ENV.toUpperCase() + " - " + document.title;

        const BACKEND_URL = CONFIG[ENV].BACKEND_URL;

        const socket = io(BACKEND_URL);
        let playerName = "";
        let playersName = []
        let roomCode = "";
        let hostName = "";

        function joinGame() {
            playerName = document.getElementById("playerInput").value.trim();
            if (!playerName) return alert("Entrez un nom de joueur");
            roomCode = prompt("Entrez le code de la salle ou laissez vide pour en créer une nouvelle");
            socket.emit("joinGame", { playerName, roomCode });
        }

        function displayQuestion(question) {
            document.getElementById("question").innerText = `C'était quand... ${question.invention} ?`;
            document.getElementById("questionImage").src=question.image;
            let answersDiv = document.getElementById("answers");
            answersDiv.innerHTML = `<p>${playerName} : <input type='number' id='answer'></p>`;
        }

        function validateAnswers() {
            let answer = parseInt(document.getElementById("answer").value);
            if (isNaN(answer)) return;
            socket.emit("submitAnswer", { roomCode, playerName, answer });
        }

        function nextRound() {
            socket.emit("nextRound", roomCode);
        }

        function updateHostDisplay() {
            if (playerName == hostName) {
                if (document.getElementById("setup").style.display === "block") {
                    document.getElementById("startGame").style.display = "inline-block";
                    document.getElementById("next").style.display = "none";
                }
                else if (document.getElementById("results").style.display === "block") {
                    document.getElementById("startGame").style.display = "none";
                    document.getElementById("next").style.display = "inline-block";
                }
            }
        }

        function updateDisplay(step) {
            if (step === "setup") {
                document.getElementById("setup").style.display = "block";
                document.getElementById("game").style.display = "none";
                document.getElementById("results").style.display = "none";
                document.getElementById("endGame").style.display = "none";
            }
            else if (step === "game") {
                document.getElementById("setup").style.display = "none";
                document.getElementById("game").style.display = "block";
                document.getElementById("results").style.display = "none";
                document.getElementById("endGame").style.display = "none";
            }
            else if (step === "results") {
                document.getElementById("setup").style.display = "none";
                document.getElementById("game").style.display = "none";
                document.getElementById("results").style.display = "block";
                document.getElementById("endGame").style.display = "none";
            }
            else if (step === "endGame") {
                document.getElementById("setup").style.display = "none";
                document.getElementById("game").style.display = "none";
                document.getElementById("results").style.display = "none";
                document.getElementById("endGame").style.display = "block";
            }
        }

        function displayPlayerList() {
            const HtmlList = [
                document.getElementById("playerListSetup"),
                document.getElementById("playerListGame")
            ];
            let listElement = ""
            for (const player of playersName) {
                listElement += "<li>" + player + "</li>";
            }
            for (const HtmlElement of HtmlList) {
                HtmlElement.innerHTML = listElement;
            }
        }

        // ------- WEBSOCKET ------- //

        socket.on("roomJoined", (code, players, host) => {
            roomCode = code;
            document.getElementById("roomCode").innerText = code;
            playersName = players;
            hostName = host;
            updateDisplay("step");
            updateHostDisplay();
            displayPlayerList();
        });

        socket.on("gameStarted", (question) => {
            updateDisplay("game");
            displayQuestion(question);
        });

        socket.on("timerUpdate", (timeLeft) => {
            const timerElement = document.getElementById("timer");
            timerElement.innerText = timeLeft;
        });

        socket.on("roundResult", ({ winners, isPerfectWinners, explanation, scores, answers }) => {
            updateDisplay("results");
            let roundResultMessage = `${winners.join(",")} gagne(nt)`;
            roundResultMessage += isPerfectWinners ? ` 3 points !` : ` 1 point !`;
            document.getElementById("roundResult").innerText = roundResultMessage;
            document.getElementById("explanation").innerText = explanation;

            let answersTable = document.getElementById("currentAnswers");
            answersTable.innerHTML = "<tr><th>Joueurs</th><th>Réponses</th></tr>";
            Object.keys(answers).forEach(player => {
                console.log(player + " " + answers[player]);
                answersTable.innerHTML += `<tr><td>${player}</td><td>${answers[player]}</td></tr>`;
            });

            let currentScoresTable = document.getElementById("currentScores");
            currentScoresTable.innerHTML = "<tr><th>Joueur</th><th>Score</th></tr>";
            Object.keys(scores).forEach(player => {
                currentScoresTable.innerHTML += `<tr><td>${player}</td><td>${scores[player]}</td></tr>`;
            });
            updateHostDisplay();
        });

        socket.on("gameEnded", ({ winners, scores, logs }) => {
            updateDisplay("endGame");
            document.getElementById("winner").innerText = `Gagnants : ${winners.join(", ")}`;
            let finalScoresTable = document.getElementById("finalScores");
            finalScoresTable.innerHTML = "<tr><th>Joueurs</th><th>Scores</th></tr>";
            Object.keys(scores).forEach(player => {
                finalScoresTable.innerHTML += `<tr><td>${player}</td><td>${scores[player]}</td></tr>`;
            });
            console.log(logs);
        });

        socket.on("errorMessage", (message) => {
            alert(message);
        });

        socket.on("playerDisconnected", (player, host) => {
            alert(player + " vient de quitter la partie");
            if (hostName != host) {
                hostName = host;
                displayPlayerList();
                if (hostName === playerName){
                    updateHostDisplay();
                    alert("Vous êtes devenu le nouvel hôte !");
                }
            }
        });

        updateDisplay("setup");
    </script>
</body>
</html>
